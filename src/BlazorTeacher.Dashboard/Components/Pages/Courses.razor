@* 
    Courses.razor - Course Dashboard Page
    A comprehensive example demonstrating:
    - Component composition
    - State management
    - Cascading parameters
    - Event handling
    - Service integration
*@

@page "/courses"
@inject CourseService CourseService
@inject AppState AppState
@rendermode InteractiveServer

<PageTitle>Course Dashboard</PageTitle>

@* Cascading parameter to provide theme to child components *@
<CascadingValue Name="Theme" Value="@AppState.CurrentTheme">
    <div class="space-y-6">
        <!-- Page Header -->
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 sm:text-3xl">Course Dashboard</h1>
                <p class="mt-1 text-sm text-slate-500">Manage your courses with full CRUD operations</p>
            </div>
            <div class="flex items-center gap-3">
                <button @onclick="ToggleTheme" 
                        class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-4 py-2.5 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 transition-colors">
                    @if (AppState.CurrentTheme == "light")
                    {
                        <svg class="h-5 w-5 mr-2 text-slate-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                        </svg>
                    }
                    else
                    {
                        <svg class="h-5 w-5 mr-2 text-amber-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                        </svg>
                    }
                    Theme
                </button>
                <button @onclick="ShowCreateForm" 
                        class="inline-flex items-center justify-center rounded-lg bg-primary-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-primary-700 transition-colors">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    New Course
                </button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(alertMessage))
        {
            <AlertMessage Message="@alertMessage" Type="@alertType" OnDismiss="DismissAlert" />
        }

        <!-- Filters Section -->
        <div class="rounded-xl bg-white p-4 shadow-sm ring-1 ring-slate-200 sm:p-6">
            <div class="flex flex-col gap-4 lg:flex-row lg:items-end">
                <!-- Search Box -->
                <div class="flex-1">
                    <label for="search" class="block text-sm font-medium text-slate-700 mb-1.5">Search</label>
                    <div class="relative">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </div>
                        <input type="text" 
                               id="search"
                               placeholder="Search courses..." 
                               @bind="searchTerm" 
                               @bind:event="oninput"
                               @onkeyup="HandleSearchKeyUp"
                               class="block w-full rounded-lg border-0 py-2.5 pl-10 pr-4 text-slate-900 ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm" />
                    </div>
                </div>
                
                <!-- Level Filter -->
                <div class="w-full sm:w-48">
                    <label for="level" class="block text-sm font-medium text-slate-700 mb-1.5">Level</label>
                    <select id="level" @bind="selectedLevel" @bind:event="onchange" 
                            class="block w-full rounded-lg border-0 py-2.5 pl-3 pr-10 text-slate-900 ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-primary-600 sm:text-sm">
                        <option value="">All Levels</option>
                        @foreach (var level in Enum.GetValues<CourseLevel>())
                        {
                            <option value="@level">@level</option>
                        }
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div class="w-full sm:w-48">
                    <label for="status" class="block text-sm font-medium text-slate-700 mb-1.5">Status</label>
                    <select id="status" @bind="selectedPublished" @bind:event="onchange"
                            class="block w-full rounded-lg border-0 py-2.5 pl-3 pr-10 text-slate-900 ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-primary-600 sm:text-sm">
                        <option value="">All Status</option>
                        <option value="true">Published</option>
                        <option value="false">Draft</option>
                    </select>
                </div>
                
                <!-- Filter Buttons -->
                <div class="flex items-center gap-2">
                    <button @onclick="ClearFilters" 
                            class="rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 transition-colors">
                        Clear
                    </button>
                    <button @onclick="ApplyFilters" 
                            class="rounded-lg bg-primary-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-primary-700 transition-colors">
                        Apply
                    </button>
                </div>
            </div>
        </div>

        <CourseList 
            Courses="@courses" 
            IsLoading="@isLoading"
            SearchTerm="@searchTerm"
            OnView="ViewCourse"
            OnEdit="EditCourse"
            OnDelete="ConfirmDeleteCourse" />

        @* Course Form Modal *@
        @if (showForm)
        {
            <div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" @onclick="CloseForm"></div>
                    <div class="relative transform overflow-hidden rounded-xl bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6" @onclick:stopPropagation>
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold leading-6 text-slate-900" id="modal-title">
                                @(editingCourse == null ? "Create New Course" : "Edit Course")
                            </h3>
                            <p class="mt-1 text-sm text-slate-500">Fill in the details below to @(editingCourse == null ? "create a new" : "update the") course.</p>
                        </div>
                        <CourseForm 
                            Course="@editingCourse"
                            OnSubmit="HandleFormSubmit"
                            OnCancel="CloseForm" />
                    </div>
                </div>
            </div>
        }

        @* Course Detail Modal *@
        @if (viewingCourse != null)
        {
            <div class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="detail-modal-title" role="dialog" aria-modal="true">
                <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" @onclick="CloseViewModal"></div>
                    <div class="relative transform overflow-hidden rounded-xl bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-md sm:p-6" @onclick:stopPropagation>
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold leading-6 text-slate-900" id="detail-modal-title">
                                @viewingCourse.Title
                            </h3>
                        </div>
                        
                        <dl class="space-y-4">
                            <div class="flex justify-between">
                                <dt class="text-sm font-medium text-slate-500">Instructor</dt>
                                <dd class="text-sm text-slate-900">@viewingCourse.Instructor</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm font-medium text-slate-500">Level</dt>
                                <dd>
                                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium @GetLevelBadgeClasses(viewingCourse.Level)">
                                        @viewingCourse.Level
                                    </span>
                                </dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm font-medium text-slate-500">Duration</dt>
                                <dd class="text-sm text-slate-900">@viewingCourse.DurationInHours hours</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm font-medium text-slate-500">Price</dt>
                                <dd class="text-sm font-semibold text-primary-600">$@viewingCourse.Price.ToString("F2")</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm font-medium text-slate-500">Status</dt>
                                <dd>
                                    @if (viewingCourse.IsPublished)
                                    {
                                        <span class="inline-flex items-center rounded-full bg-emerald-50 px-2.5 py-0.5 text-xs font-medium text-emerald-700">Published</span>
                                    }
                                    else
                                    {
                                        <span class="inline-flex items-center rounded-full bg-amber-50 px-2.5 py-0.5 text-xs font-medium text-amber-700">Draft</span>
                                    }
                                </dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-sm font-medium text-slate-500">Lessons</dt>
                                <dd class="text-sm text-slate-900">@viewingCourse.LessonCount</dd>
                            </div>
                            <div class="pt-2 border-t border-slate-100">
                                <dt class="text-sm font-medium text-slate-500 mb-2">Description</dt>
                                <dd class="text-sm text-slate-700 leading-relaxed">@viewingCourse.Description</dd>
                            </div>
                        </dl>
                        
                        <div class="mt-6">
                            <button @onclick="CloseViewModal" 
                                    class="w-full rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        <ConfirmDialog 
            IsOpen="@showDeleteConfirm"
            Title="Delete Course"
            Message="@($"Are you sure you want to delete '{courseToDelete?.Title}'? This action cannot be undone.")"
            ConfirmText="Delete"
            ConfirmButtonType="danger"
            OnClose="HandleDeleteConfirmation" />
    </div>
</CascadingValue>

@code {
    private List<CourseDto>? courses;
    private bool isLoading = true;
    private string searchTerm = "";
    private CourseLevel? selectedLevel;
    private string? selectedPublished;
    
    private bool showForm = false;
    private CourseDto? editingCourse;
    private CourseDto? viewingCourse;
    
    private bool showDeleteConfirm = false;
    private CourseDto? courseToDelete;
    
    private string? alertMessage;
    private string alertType = "info";

    protected override async Task OnInitializedAsync()
    {
        await LoadCourses();
        
        // Subscribe to state changes
        AppState.OnChange += StateHasChanged;
    }

    private async Task LoadCourses()
    {
        isLoading = true;
        
        bool? isPublished = string.IsNullOrEmpty(selectedPublished) 
            ? null 
            : bool.Parse(selectedPublished);
        
        courses = await CourseService.GetCoursesAsync(selectedLevel, isPublished, searchTerm);
        isLoading = false;
    }

    private async Task SearchCourses()
    {
        await LoadCourses();
    }

    private async Task HandleSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchCourses();
        }
    }

    private async Task ApplyFilters()
    {
        await LoadCourses();
    }

    private async Task ClearFilters()
    {
        searchTerm = "";
        selectedLevel = null;
        selectedPublished = null;
        await LoadCourses();
    }

    private void ToggleTheme()
    {
        AppState.ToggleTheme();
    }

    private void ShowCreateForm()
    {
        editingCourse = null;
        showForm = true;
    }

    private void EditCourse(CourseDto course)
    {
        editingCourse = course;
        showForm = true;
    }

    private void ViewCourse(CourseDto course)
    {
        viewingCourse = course;
    }

    private void CloseViewModal()
    {
        viewingCourse = null;
    }

    private void CloseForm()
    {
        showForm = false;
        editingCourse = null;
    }

    private async Task HandleFormSubmit(CourseForm.CourseFormModel model)
    {
        if (editingCourse == null)
        {
            // Create new course
            var createDto = new CreateCourseDto(
                model.Title,
                model.Description,
                model.Instructor,
                model.DurationInHours,
                model.Price,
                model.Level);
            
            var result = await CourseService.CreateCourseAsync(createDto);
            if (result != null)
            {
                ShowAlert("Course created successfully!", "success");
                await LoadCourses();
            }
            else
            {
                ShowAlert("Failed to create course.", "error");
            }
        }
        else
        {
            // Update existing course
            var updateDto = new UpdateCourseDto(
                model.Title,
                model.Description,
                model.Instructor,
                model.DurationInHours,
                model.Price,
                model.Level,
                model.IsPublished);
            
            var result = await CourseService.UpdateCourseAsync(editingCourse.Id, updateDto);
            if (result != null)
            {
                ShowAlert("Course updated successfully!", "success");
                await LoadCourses();
            }
            else
            {
                ShowAlert("Failed to update course.", "error");
            }
        }
        
        CloseForm();
    }

    private void ConfirmDeleteCourse(CourseDto course)
    {
        courseToDelete = course;
        showDeleteConfirm = true;
    }

    private async Task HandleDeleteConfirmation(bool confirmed)
    {
        showDeleteConfirm = false;
        
        if (confirmed && courseToDelete != null)
        {
            var success = await CourseService.DeleteCourseAsync(courseToDelete.Id);
            if (success)
            {
                ShowAlert("Course deleted successfully!", "success");
                await LoadCourses();
            }
            else
            {
                ShowAlert("Failed to delete course.", "error");
            }
        }
        
        courseToDelete = null;
    }

    private void ShowAlert(string message, string type)
    {
        alertMessage = message;
        alertType = type;
    }

    private void DismissAlert()
    {
        alertMessage = null;
    }

    private string GetLevelBadgeClasses(CourseLevel level) => level switch
    {
        CourseLevel.Beginner => "bg-emerald-50 text-emerald-700",
        CourseLevel.Intermediate => "bg-amber-50 text-amber-700",
        CourseLevel.Advanced => "bg-rose-50 text-rose-700",
        _ => "bg-slate-50 text-slate-700"
    };

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }
}
