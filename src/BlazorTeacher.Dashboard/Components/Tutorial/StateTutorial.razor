@page "/tutorial/state"
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime

<PageTitle>State Management Tutorial</PageTitle>

<div class="tutorial-page">
    <h1>üîÑ State Management & Component Communication</h1>
    <p class="subtitle">Master parameters, cascading values, event callbacks, and state patterns</p>

    <nav class="tutorial-toc">
        <h3>Table of Contents</h3>
        <ul>
            <li><a href="#parameters">Component Parameters</a></li>
            <li><a href="#cascading">Cascading Parameters</a></li>
            <li><a href="#callbacks">Event Callbacks</a></li>
            <li><a href="#state">State Management Patterns</a></li>
            <li><a href="#styling">CSS Isolation & Styling</a></li>
        </ul>
    </nav>

    <section id="parameters" class="tutorial-section">
        <h2>1. Component Parameters</h2>
        <p>Parameters allow parent components to pass data to child components.</p>
        
        <div class="tutorial-code-block">
            <div class="tutorial-code-header">CourseCard.razor - Child Component</div>
            <pre><code class="language-csharp">@@* Parameters are defined in the @@code block *@@
&lt;div class="course-card"&gt;
    &lt;h3&gt;@@Course.Title&lt;/h3&gt;
    &lt;p&gt;By @@Course.Instructor&lt;/p&gt;
&lt;/div&gt;

@@code {
    // Required parameter
    [Parameter, EditorRequired]
    public CourseDto Course { get; set; } = null!;

    // Optional parameter with default value
    [Parameter]
    public bool ShowDetails { get; set; } = true;

    // Arbitrary attributes (HTML attributes passed through)
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary&lt;string, object&gt;? AdditionalAttributes { get; set; }
}</code></pre>
        </div>

        <div class="tutorial-code-block">
            <div class="tutorial-code-header">Parent Component Usage</div>
            <pre><code class="language-csharp">@@* Passing parameters to child components *@@
&lt;CourseCard Course="@@selectedCourse" ShowDetails="@@true" /&gt;

@@* Passing arbitrary HTML attributes *@@
&lt;CourseCard Course="@@course" class="featured" data-id="123" /&gt;</code></pre>
        </div>

        <div class="tutorial-info-box">
            <strong>üí° Best Practices:</strong>
            <ul>
                <li>Use <code>[EditorRequired]</code> for mandatory parameters</li>
                <li>Provide default values for optional parameters</li>
                <li>Parameters should be immutable - don't modify them directly</li>
                <li>Use <code>OnParametersSet</code> to react to parameter changes</li>
            </ul>
        </div>
    </section>

    <section id="cascading" class="tutorial-section">
        <h2>2. Cascading Parameters</h2>
        <p>Cascading parameters automatically flow down to all descendant components without explicit passing.</p>
        
        <div class="tutorial-diagram">
            <div class="tutorial-diagram-box parent">
                <strong>Parent Component</strong>
                <code>&lt;CascadingValue Value="@@theme"&gt;</code>
            </div>
            <div class="tutorial-diagram-arrow">‚Üì</div>
            <div class="tutorial-diagram-box child">
                <strong>Child Component</strong>
                <code>[CascadingParameter] Theme</code>
            </div>
            <div class="tutorial-diagram-arrow">‚Üì</div>
            <div class="tutorial-diagram-box grandchild">
                <strong>Grandchild Component</strong>
                <code>[CascadingParameter] Theme</code>
            </div>
        </div>

        <div class="tutorial-code-block">
            <div class="tutorial-code-header">App.razor or Layout - Provider</div>
            <pre><code class="language-csharp">@@* Provide cascading value *@@
&lt;CascadingValue Value="@@currentTheme" Name="Theme"&gt;
    &lt;CascadingValue Value="@@currentUser" Name="User"&gt;
        @@Body
    &lt;/CascadingValue&gt;
&lt;/CascadingValue&gt;

@@code {
    private string currentTheme = "light";
    private UserInfo currentUser = new();
}</code></pre>
        </div>

        <div class="tutorial-code-block">
            <div class="tutorial-code-header">Any Descendant Component - Consumer</div>
            <pre><code class="language-csharp">&lt;div class="card @@ThemeClass"&gt;
    &lt;p&gt;Welcome, @@User?.Name&lt;/p&gt;
&lt;/div&gt;

@@code {
    // Named cascading parameter
    [CascadingParameter(Name = "Theme")]
    public string? Theme { get; set; }

    // Type-based cascading parameter
    [CascadingParameter]
    public UserInfo? User { get; set; }

    private string ThemeClass =&gt; Theme == "dark" ? "dark-theme" : "";
}</code></pre>
        </div>

        <div class="tutorial-info-box warning">
            <strong>‚ö†Ô∏è Use Cases:</strong>
            <ul>
                <li>Theme information</li>
                <li>User authentication state</li>
                <li>Form validation context (EditContext)</li>
                <li>Layout configuration</li>
            </ul>
            <p><strong>Avoid for:</strong> Frequently changing data or large objects</p>
        </div>
    </section>

    <section id="callbacks" class="tutorial-section">
        <h2>3. Event Callbacks</h2>
        <p>Event callbacks enable child-to-parent communication.</p>
        
        <div class="tutorial-code-block">
            <div class="tutorial-code-header">Child Component - CourseCard.razor</div>
            <pre><code class="language-csharp">&lt;div class="course-card"&gt;
    &lt;h3&gt;@@Course.Title&lt;/h3&gt;
    &lt;button @@onclick="HandleView"&gt;View&lt;/button&gt;
    &lt;button @@onclick="HandleDelete"&gt;Delete&lt;/button&gt;
&lt;/div&gt;

@@code {
    [Parameter]
    public CourseDto Course { get; set; } = null!;

    // EventCallback for simple notifications
    [Parameter]
    public EventCallback OnView { get; set; }

    // EventCallback&lt;T&gt; for passing data back
    [Parameter]
    public EventCallback&lt;CourseDto&gt; OnDelete { get; set; }

    private async Task HandleView()
    {
        await OnView.InvokeAsync();
    }

    private async Task HandleDelete()
    {
        await OnDelete.InvokeAsync(Course);
    }
}</code></pre>
        </div>

        <div class="tutorial-code-block">
            <div class="tutorial-code-header">Parent Component</div>
            <pre><code class="language-csharp">@@foreach (var course in courses)
{
    &lt;CourseCard 
        Course="@@course"
        OnView="@@(() =&gt; ViewCourse(course))"
        OnDelete="@@HandleDeleteCourse" /&gt;
}

@@code {
    private void ViewCourse(CourseDto course)
    {
        selectedCourse = course;
    }

    private async Task HandleDeleteCourse(CourseDto course)
    {
        await CourseService.DeleteAsync(course.Id);
        await LoadCourses();
    }
}</code></pre>
        </div>
    </section>

    <section id="state" class="tutorial-section">
        <h2>4. State Management Patterns</h2>
        <p>Different patterns for managing state based on your needs.</p>
        
        <h3>Pattern 1: Component State</h3>
        <div class="tutorial-code-block">
            <div class="tutorial-code-header">Local Component State</div>
            <pre><code class="language-csharp">@@code {
    // Local state - only affects this component
    private List&lt;CourseDto&gt; courses = new();
    private bool isLoading = true;
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        courses = await CourseService.GetCoursesAsync();
        isLoading = false;
    }

    private void UpdateSearch(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        StateHasChanged(); // Usually automatic, explicit when needed
    }
}</code></pre>
        </div>

        <h3>Pattern 2: State Container Service</h3>
        <div class="tutorial-code-block">
            <div class="tutorial-code-header">Services/AppState.cs</div>
            <pre><code class="language-csharp">public class AppState
{
    private string _theme = "light";

    public string Theme
    {
        get =&gt; _theme;
        set
        {
            if (_theme != value)
            {
                _theme = value;
                NotifyStateChanged();
            }
        }
    }

    // Event for components to subscribe
    public event Action? OnChange;

    private void NotifyStateChanged() =&gt; OnChange?.Invoke();
}</code></pre>
        </div>

        <div class="tutorial-code-block">
            <div class="tutorial-code-header">Component using State Container</div>
            <pre><code class="language-csharp">@@inject AppState AppState
@@implements IDisposable

&lt;div class="@@ThemeClass"&gt;
    &lt;button @@onclick="ToggleTheme"&gt;Toggle Theme&lt;/button&gt;
&lt;/div&gt;

@@code {
    private string ThemeClass =&gt; AppState.Theme == "dark" ? "dark" : "";

    protected override void OnInitialized()
    {
        // Subscribe to state changes
        AppState.OnChange += StateHasChanged;
    }

    private void ToggleTheme()
    {
        AppState.Theme = AppState.Theme == "light" ? "dark" : "light";
    }

    public void Dispose()
    {
        // Always unsubscribe!
        AppState.OnChange -= StateHasChanged;
    }
}</code></pre>
        </div>

        <h3>Pattern Comparison</h3>
        <table class="tutorial-comparison-table">
            <thead>
                <tr>
                    <th>Pattern</th>
                    <th>Scope</th>
                    <th>Use When</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Component State</td>
                    <td>Single component</td>
                    <td>UI state, form data</td>
                </tr>
                <tr>
                    <td>Cascading Parameters</td>
                    <td>Component tree</td>
                    <td>Theme, auth context</td>
                </tr>
                <tr>
                    <td>State Container</td>
                    <td>Application-wide</td>
                    <td>Shared data across unrelated components</td>
                </tr>
            </tbody>
        </table>
    </section>

    <section id="styling" class="tutorial-section">
        <h2>5. CSS Isolation & Styling</h2>
        <p>Blazor supports CSS isolation for component-scoped styles.</p>
        
        <div class="tutorial-file-tree">
            <div class="tree-item">üìÅ Components/Course/</div>
            <div class="tree-item indent-1">üìÑ CourseCard.razor</div>
            <div class="tree-item indent-1">üìÑ CourseCard.razor.css ‚Üê Isolated styles</div>
        </div>

        <div class="tutorial-code-block">
            <div class="tutorial-code-header">CourseCard.razor.css</div>
            <pre><code class="language-css">/* These styles only apply to CourseCard component */
.course-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.course-card:hover {
    transform: translateY(-4px);
}

/* ::deep targets child components */
::deep .child-element {
    color: blue;
}</code></pre>
        </div>

        <div class="tutorial-info-box success">
            <strong>üé® How CSS Isolation Works:</strong>
            <ul>
                <li>Blazor adds unique identifiers to elements (e.g., <code>b-xyz123</code>)</li>
                <li>CSS selectors are scoped to match these identifiers</li>
                <li>Use <code>::deep</code> to target child component elements</li>
                <li>All isolated styles are bundled into <code>{ProjectName}.styles.css</code></li>
            </ul>
        </div>
    </section>

    <div class="tutorial-next-steps">
        <h3>üéâ Congratulations!</h3>
        <p>You've completed the Blazor Teacher tutorial! Now try building the Course Dashboard to apply what you've learned.</p>
        <a href="/courses" class="tutorial-btn tutorial-btn-primary">Go to Course Dashboard ‚Üí</a>
    </div>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("PrismHelper.highlightAll");
        }
    }
}
