@page "/tutorial/state"

<PageTitle>State Management Tutorial</PageTitle>

<div class="tutorial-page">
    <h1>üîÑ State Management & Component Communication</h1>
    <p class="subtitle">Master parameters, cascading values, event callbacks, and state patterns</p>

    <nav class="table-of-contents">
        <h3>Table of Contents</h3>
        <ul>
            <li><a href="#parameters">Component Parameters</a></li>
            <li><a href="#cascading">Cascading Parameters</a></li>
            <li><a href="#callbacks">Event Callbacks</a></li>
            <li><a href="#state">State Management Patterns</a></li>
            <li><a href="#styling">CSS Isolation & Styling</a></li>
        </ul>
    </nav>

    <section id="parameters" class="tutorial-section">
        <h2>1. Component Parameters</h2>
        <p>Parameters allow parent components to pass data to child components.</p>
        
        <div class="code-block">
            <div class="code-header">CourseCard.razor - Child Component</div>
            <pre><code>@@* Parameters are defined in the @@code block *@@
&lt;div class="course-card"&gt;
    &lt;h3&gt;@@Course.Title&lt;/h3&gt;
    &lt;p&gt;By @@Course.Instructor&lt;/p&gt;
&lt;/div&gt;

@@code {
    // Required parameter
    [Parameter, EditorRequired]
    public CourseDto Course { get; set; } = null!;

    // Optional parameter with default value
    [Parameter]
    public bool ShowDetails { get; set; } = true;

    // Arbitrary attributes (HTML attributes passed through)
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary&lt;string, object&gt;? AdditionalAttributes { get; set; }
}</code></pre>
        </div>

        <div class="code-block">
            <div class="code-header">Parent Component Usage</div>
            <pre><code>@@* Passing parameters to child components *@@
&lt;CourseCard Course="@@selectedCourse" ShowDetails="@@true" /&gt;

@@* Passing arbitrary HTML attributes *@@
&lt;CourseCard Course="@@course" class="featured" data-id="123" /&gt;</code></pre>
        </div>

        <div class="info-box">
            <strong>üí° Best Practices:</strong>
            <ul>
                <li>Use <code>[EditorRequired]</code> for mandatory parameters</li>
                <li>Provide default values for optional parameters</li>
                <li>Parameters should be immutable - don't modify them directly</li>
                <li>Use <code>OnParametersSet</code> to react to parameter changes</li>
            </ul>
        </div>
    </section>

    <section id="cascading" class="tutorial-section">
        <h2>2. Cascading Parameters</h2>
        <p>Cascading parameters automatically flow down to all descendant components without explicit passing.</p>
        
        <div class="diagram">
            <div class="diagram-box parent">
                <strong>Parent Component</strong>
                <code>&lt;CascadingValue Value="@@theme"&gt;</code>
            </div>
            <div class="diagram-arrow">‚Üì</div>
            <div class="diagram-box child">
                <strong>Child Component</strong>
                <code>[CascadingParameter] Theme</code>
            </div>
            <div class="diagram-arrow">‚Üì</div>
            <div class="diagram-box grandchild">
                <strong>Grandchild Component</strong>
                <code>[CascadingParameter] Theme</code>
            </div>
        </div>

        <div class="code-block">
            <div class="code-header">App.razor or Layout - Provider</div>
            <pre><code>@@* Provide cascading value *@@
&lt;CascadingValue Value="@@currentTheme" Name="Theme"&gt;
    &lt;CascadingValue Value="@@currentUser" Name="User"&gt;
        @@Body
    &lt;/CascadingValue&gt;
&lt;/CascadingValue&gt;

@@code {
    private string currentTheme = "light";
    private UserInfo currentUser = new();
}</code></pre>
        </div>

        <div class="code-block">
            <div class="code-header">Any Descendant Component - Consumer</div>
            <pre><code>&lt;div class="card @@ThemeClass"&gt;
    &lt;p&gt;Welcome, @@User?.Name&lt;/p&gt;
&lt;/div&gt;

@@code {
    // Named cascading parameter
    [CascadingParameter(Name = "Theme")]
    public string? Theme { get; set; }

    // Type-based cascading parameter
    [CascadingParameter]
    public UserInfo? User { get; set; }

    private string ThemeClass =&gt; Theme == "dark" ? "dark-theme" : "";
}</code></pre>
        </div>

        <div class="info-box info-warning">
            <strong>‚ö†Ô∏è Use Cases:</strong>
            <ul>
                <li>Theme information</li>
                <li>User authentication state</li>
                <li>Form validation context (EditContext)</li>
                <li>Layout configuration</li>
            </ul>
            <p><strong>Avoid for:</strong> Frequently changing data or large objects</p>
        </div>
    </section>

    <section id="callbacks" class="tutorial-section">
        <h2>3. Event Callbacks</h2>
        <p>Event callbacks enable child-to-parent communication.</p>
        
        <div class="code-block">
            <div class="code-header">Child Component - CourseCard.razor</div>
            <pre><code>&lt;div class="course-card"&gt;
    &lt;h3&gt;@@Course.Title&lt;/h3&gt;
    &lt;button @@onclick="HandleView"&gt;View&lt;/button&gt;
    &lt;button @@onclick="HandleDelete"&gt;Delete&lt;/button&gt;
&lt;/div&gt;

@@code {
    [Parameter]
    public CourseDto Course { get; set; } = null!;

    // EventCallback for simple notifications
    [Parameter]
    public EventCallback OnView { get; set; }

    // EventCallback&lt;T&gt; for passing data back
    [Parameter]
    public EventCallback&lt;CourseDto&gt; OnDelete { get; set; }

    private async Task HandleView()
    {
        await OnView.InvokeAsync();
    }

    private async Task HandleDelete()
    {
        await OnDelete.InvokeAsync(Course);
    }
}</code></pre>
        </div>

        <div class="code-block">
            <div class="code-header">Parent Component</div>
            <pre><code>@@foreach (var course in courses)
{
    &lt;CourseCard 
        Course="@@course"
        OnView="@@(() =&gt; ViewCourse(course))"
        OnDelete="@@HandleDeleteCourse" /&gt;
}

@@code {
    private void ViewCourse(CourseDto course)
    {
        selectedCourse = course;
    }

    private async Task HandleDeleteCourse(CourseDto course)
    {
        await CourseService.DeleteAsync(course.Id);
        await LoadCourses();
    }
}</code></pre>
        </div>
    </section>

    <section id="state" class="tutorial-section">
        <h2>4. State Management Patterns</h2>
        <p>Different patterns for managing state based on your needs.</p>
        
        <h3>Pattern 1: Component State</h3>
        <div class="code-block">
            <div class="code-header">Local Component State</div>
            <pre><code>@@code {
    // Local state - only affects this component
    private List&lt;CourseDto&gt; courses = new();
    private bool isLoading = true;
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        courses = await CourseService.GetCoursesAsync();
        isLoading = false;
    }

    private void UpdateSearch(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        StateHasChanged(); // Usually automatic, explicit when needed
    }
}</code></pre>
        </div>

        <h3>Pattern 2: State Container Service</h3>
        <div class="code-block">
            <div class="code-header">Services/AppState.cs</div>
            <pre><code>public class AppState
{
    private string _theme = "light";

    public string Theme
    {
        get =&gt; _theme;
        set
        {
            if (_theme != value)
            {
                _theme = value;
                NotifyStateChanged();
            }
        }
    }

    // Event for components to subscribe
    public event Action? OnChange;

    private void NotifyStateChanged() =&gt; OnChange?.Invoke();
}</code></pre>
        </div>

        <div class="code-block">
            <div class="code-header">Component using State Container</div>
            <pre><code>@@inject AppState AppState
@@implements IDisposable

&lt;div class="@@ThemeClass"&gt;
    &lt;button @@onclick="ToggleTheme"&gt;Toggle Theme&lt;/button&gt;
&lt;/div&gt;

@@code {
    private string ThemeClass =&gt; AppState.Theme == "dark" ? "dark" : "";

    protected override void OnInitialized()
    {
        // Subscribe to state changes
        AppState.OnChange += StateHasChanged;
    }

    private void ToggleTheme()
    {
        AppState.Theme = AppState.Theme == "light" ? "dark" : "light";
    }

    public void Dispose()
    {
        // Always unsubscribe!
        AppState.OnChange -= StateHasChanged;
    }
}</code></pre>
        </div>

        <h3>Pattern Comparison</h3>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Pattern</th>
                    <th>Scope</th>
                    <th>Use When</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Component State</td>
                    <td>Single component</td>
                    <td>UI state, form data</td>
                </tr>
                <tr>
                    <td>Cascading Parameters</td>
                    <td>Component tree</td>
                    <td>Theme, auth context</td>
                </tr>
                <tr>
                    <td>State Container</td>
                    <td>Application-wide</td>
                    <td>Shared data across unrelated components</td>
                </tr>
            </tbody>
        </table>
    </section>

    <section id="styling" class="tutorial-section">
        <h2>5. CSS Isolation & Styling</h2>
        <p>Blazor supports CSS isolation for component-scoped styles.</p>
        
        <div class="file-tree">
            <div class="tree-item">üìÅ Components/Course/</div>
            <div class="tree-item indent-1">üìÑ CourseCard.razor</div>
            <div class="tree-item indent-1">üìÑ CourseCard.razor.css ‚Üê Isolated styles</div>
        </div>

        <div class="code-block">
            <div class="code-header">CourseCard.razor.css</div>
            <pre><code>/* These styles only apply to CourseCard component */
.course-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.course-card:hover {
    transform: translateY(-4px);
}

/* ::deep targets child components */
::deep .child-element {
    color: blue;
}</code></pre>
        </div>

        <div class="info-box">
            <strong>üé® How CSS Isolation Works:</strong>
            <ul>
                <li>Blazor adds unique identifiers to elements (e.g., <code>b-xyz123</code>)</li>
                <li>CSS selectors are scoped to match these identifiers</li>
                <li>Use <code>::deep</code> to target child component elements</li>
                <li>All isolated styles are bundled into <code>{ProjectName}.styles.css</code></li>
            </ul>
        </div>
    </section>

    <div class="next-steps">
        <h3>üéâ Congratulations!</h3>
        <p>You've completed the Blazor Teacher tutorial! Now try building the Course Dashboard to apply what you've learned.</p>
        <a href="/courses" class="btn btn-primary">Go to Course Dashboard ‚Üí</a>
    </div>
</div>

<style>
    .tutorial-page {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
        line-height: 1.7;
    }

    .tutorial-page h1 { margin-bottom: 0.5rem; }
    .subtitle { color: #666; font-size: 1.1rem; margin-bottom: 2rem; }

    .table-of-contents {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .table-of-contents h3 { margin: 0 0 1rem 0; }
    .table-of-contents ul { margin: 0; padding-left: 1.5rem; }
    .table-of-contents li { margin: 0.5rem 0; }
    .table-of-contents a { color: #3498db; text-decoration: none; }

    .tutorial-section {
        margin-bottom: 3rem;
        padding-top: 1rem;
        border-top: 1px solid #eee;
    }

    .code-block {
        background: #1e1e1e;
        border-radius: 8px;
        overflow: hidden;
        margin: 1rem 0;
    }

    .code-header {
        background: #333;
        color: #aaa;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
    }

    .code-block pre {
        margin: 0;
        padding: 1rem;
        overflow-x: auto;
    }

    .code-block code {
        color: #d4d4d4;
        font-family: 'Consolas', monospace;
        font-size: 0.9rem;
    }

    .diagram {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .diagram-box {
        padding: 1rem 2rem;
        border-radius: 8px;
        text-align: center;
        min-width: 200px;
    }

    .diagram-box.parent { background: #e3f2fd; }
    .diagram-box.child { background: #e8f5e9; }
    .diagram-box.grandchild { background: #fff3e0; }

    .diagram-box code {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.8rem;
    }

    .diagram-arrow {
        font-size: 2rem;
        color: #666;
        margin: 0.5rem 0;
    }

    .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0 8px 8px 0;
    }

    .info-box.info-warning {
        background: #fff8e1;
        border-left-color: #ffc107;
    }

    .info-box ul {
        margin: 0.5rem 0 0 1.5rem;
        padding: 0;
    }

    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }

    .comparison-table th,
    .comparison-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    .comparison-table th {
        background: #f8f9fa;
        font-weight: 600;
    }

    .file-tree {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        font-family: monospace;
        margin: 1rem 0;
    }

    .tree-item { padding: 0.25rem 0; }
    .indent-1 { margin-left: 1.5rem; }

    .next-steps {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
    }

    .next-steps h3 { margin: 0 0 1rem 0; }
    .next-steps p { margin: 0 0 1.5rem 0; opacity: 0.9; }

    .btn {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
    }

    .btn-primary {
        background: white;
        color: #667eea;
    }
</style>
